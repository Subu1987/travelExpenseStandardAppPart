/*
 * Copyright (C) 2009-2022 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/fin/travel/lib/reuse/util/PersistenceHelper","sap/fin/travel/lib/reuse/util/TravelUtil","sap/fin/travel/lib/reuse/util/i18n","sap/ui/model/resource/ResourceModel","sap/fin/travel/lib/reuse/util/DateFormatter","sap/fin/travel/lib/reuse/util/MessageUtil","sap/ui/core/MessageType","sap/m/MessageToast","sap/fin/travel/lib/reuse/util/FragmentHelper","sap/fin/travel/lib/reuse/util/MessageParser"],function(P,T,I,R,D,M,a,b,F,c){"use strict";var t="TripBreakFragmentId";var o=new sap.ui.model.json.JSONModel();function d(e,f){var m=e.getSource();F.get().loadFragment({id:t,name:"sap.fin.travel.lib.reuse.view.fragments.TripBreak",controller:this,models:{i18n:f.getView().getModel("i18n")}}).then(function(g){g.addCustomData(new sap.ui.core.CustomData({key:"oParent",value:null}));g.setModel(o,"tripBreakDialogModel");var r=sap.ui.core.Fragment.byId(t,"recurrenceInput");r.attachSelectionChange(f,H);sap.ui.core.Fragment.byId(t,"submitButton").attachPress(f,C);sap.ui.core.Fragment.byId(t,"cancelButton").attachPress(function(q){g.close();});g.data("oSmartTable",m.getParent().getParent());var i=m.getModel().getObject(m.getBindingContext().getPath());if(!i.Datedep){b.show(I.get().getText(f,"TRIP_BREAK_REQUIRES_START_DATE"));return;}var s=i.Datedep&&i.Datedep.getTime();s=i.Timedep&&i.Timedep.ms?s+i.Timedep.ms:s;var j=new Date(s+60000);var k=new Date(s+2*60000);var l=i.Tripno;var p=i.Pernr;var n={startDate:j,endDate:k,recurrence:"N",number:"1",numberEditable:false,pernr:p,tripno:l,stripMessage:"",stripType:a.None};o.setData(n);var S=i.Datedep;var E=i.Datearr;if(E===null){E=S;}sap.ui.core.Fragment.byId(t,"recurrenceInput").setSelectedKey("N");sap.ui.core.Fragment.byId(t,"numberTripBreakInput").setValueState(sap.ui.core.ValueState.None);g.open();});}function C(e,f){var E=e.getSource();var n=sap.ui.core.Fragment.byId(t,"numberTripBreakInput");if(n!==undefined&&sap.ui.core.ValueState.Error===n.getValueState()){return;}var p={BeginDate:o.getProperty("/startDate"),EndDate:o.getProperty("/endDate"),Number:o.getProperty("/number"),Recurrence:o.getProperty("/recurrence"),Pernr:o.getProperty("/pernr"),Tripno:o.getProperty("/tripno")};var g=function(i,r){if(r===undefined){return;}var j=M.get().getErrorMessageResponse(r);o.setProperty("/stripMessage",j.hasOwnProperty("message")?j.message:j);var k=j.hasOwnProperty("type")?c.ErrorType.toMessageType(j.type):a.Error;o.setProperty("/stripType",k);};var s=function(i,r){var j=F.get().getFragment(t);if(j){var k=j.data("oSmartTable");k.rebindTable();j.close();}};var S=function(){P.callFunction(f.getView().getModel(),{name:"/CreateTripBreak",settings:{async:true,},source:E,urlParameters:p,success:s,functionalError:g,error:g});};P.submitChanges(f.getView().getModel(),{source:E,success:S,functionalError:S,error:g,submitChangeOrigin:P.SUBMIT_CHANGE_ORIGIN.ACTION,});}function h(e,f){var r=Number(e.getSource().getValue());if(r>0){e.getSource().setValue(r);var p=e.getSource().getBindingInfo("value").binding.getPath();o.setProperty(p,r);}else{e.getSource().setValueState(sap.ui.core.ValueState.Error);e.getSource().setValueStateText(I.get().getText(f,"TRIP_BREAK_RECURRENCE_ERROR"));e.getSource().focus();}}function H(e,f){var E=e.getSource();var g=this;if(e.getParameter("selectedItem")){o.setProperty("/recurrence",e.getParameter("selectedItem").getProperty("key"));}else{o.setProperty("/recurrence","N");}if(o.getProperty("/recurrence")==="N"){o.setProperty("/number","1");o.setProperty("/numberEditable",false);}else{o.setProperty("/numberEditable",true);var s=function(i){o.setProperty("/number",i.GetMaxOccurences.Value);};var p={BeginDate:o.getProperty("/startDate"),EndDate:o.getProperty("/endDate"),Recurrence:o.getProperty("/recurrence"),Pernr:o.getProperty("/pernr"),Tripno:o.getProperty("/tripno")};P.callFunction(f.getView().getModel(),{name:"/GetMaxOccurences",urlParameters:p,source:E,success:s,settings:{async:true}});}}return{handleAddTripBreak:d};});
