/*
 * Copyright (C) 2009-2022 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/model/Context","sap/fin/travel/lib/reuse/util/FCLayoutUtil","sap/f/routing/Router","sap/fin/travel/lib/reuse/model/models","sap/fin/travel/lib/reuse/util/PaginatorHelper","sap/fin/travel/lib/reuse/util/NavigationUtil","sap/ui/core/routing/HashChanger","sap/fin/travel/lib/reuse/util/MessageUtil","sap/fin/travel/lib/reuse/util/i18n","sap/fin/travel/lib/reuse/util/ODataModelUtil","sap/fin/travel/lib/reuse/util/ShellUtil","sap/fin/travel/lib/reuse/util/FragmentHelper","sap/fin/travel/lib/reuse/util/Utils","sap/fin/travel/lib/reuse/util/TravelUtil","sap/fin/travel/lib/reuse/util/AppDescriptorUtil","sap/fin/travel/lib/reuse/util/StateUtil","sap/fin/travel/lib/reuse/util/BusyHelper"],function(C,F,R,m,P,N,H,M,I,O,S,a,U,T,A,b,B){"use strict";var _;var c;var d;var f=new Map();var g=new Map();var h=0;var l=new Map();var n;var r;var D;function p(i){var e=Object.keys(i).map(function(k){var j=i[k];if(j.pages){j.pages=p(j.pages);}return i[k];});return e;}function o(){if(!n){if(c&&c.hasOwnProperty("appDescriptor")&&c.appDescriptor["sap.ui.generic.app"]!=undefined){n=c.appDescriptor["sap.ui.generic.app"];n=_.getManifestEntry("sap.ui.generic.app")!=undefined?A.mergeDescriptors(n,_.getManifestEntry("sap.ui.generic.app")):n;}else{n=_.getManifestEntry("sap.ui.generic.app");}}return n;}function q(s,e,i,j,k){var v;if(!U.isEmptyObjectOrString(c.manifest)){if("sap.fin.travel.lib.reuse.ListPage"===s){v=c.manifest.ListPage;}else if("sap.fin.travel.lib.reuse.DetailPage"===s){v=c.manifest.DetailPage;}var W=v["sap.ui5"];var X=_.getManifestEntry("sap.ui5");if(W){if(X.hasOwnProperty("extends")){W.extends=W.extends||{};A.overrideControllers(X);W.extends=A.mergeDescriptors(W.extends,X.extends);}}}else{var Y=jQuery.sap.getModulePath(c.manifestPath)+"/";if("sap.fin.travel.lib.reuse.ListPage"===s){Y+="ListPage.manifest.json";}else if("sap.fin.travel.lib.reuse.DetailPage"===s){Y+="DetailPage.manifest.json";}v=Y;}var Z=sap.ui.component({name:s,manifest:v,componentData:{oModel:d,oRouter:r,oAppDescriptor:c.appDescriptor,oAppManifest:_.getMetadata().getManifest(),oAppComponent:_,sEntitySet:e,oShell:i,aBreadCrumb:j,oAppResourceBundle:_.getResourceBundle(),extension:c.extension},id:k});return Z;}function t(e,i,s,j){var k=e.component.name+"."+e.entitySet;h=h<i?i:h;var v=function(W){var X=e.component.name+"."+e.entitySet;if(jQuery.sap.log.Level.DEBUG===jQuery.sap.log.getLevel()){jQuery.sap.measure.start(X,"Measurement of "+X);}var Y=q(e.component.name,e.entitySet,e.routingSpec,j,k);if(jQuery.sap.log.Level.DEBUG===jQuery.sap.log.getLevel()){jQuery.sap.measure.end(X);}return Y;};return{id:k,pattern:s,level:i,entity:e.entitySet,resolve:v};}function u(j,k,s,v){if(jQuery.sap.log.Level.DEBUG===jQuery.sap.log.getLevel()){jQuery.sap.measure.setActive(true);jQuery.sap.measure.start("fi-fio-tv-component-creation","Creation of the different promise's component for the application");}j=j||o();if(U.isEmptyObjectOrString(j.pages)){return[];}v=v||[];k=k||F.layout.beginColumn.level;s=s||"";$.each(j.pages,function(i,e){var W=s;var X=Array.from(v);if(k>F.layout.beginColumn.level){W=s+"/"+e.entitySet+"({keys"+k+"})";X.push(e.navigationProperty||e.entitySet);}else if(k===0){c.rootComponent=c.rootComponent||e.component&&e.component.name&&e.component.name.concat(".",e.entitySet);}var Y=t(e,k,W,X);if(l.has(Y.id)){l.get(Y.id).routes.push({level:Y.level,pattern:Y.pattern});}else{l.set(Y.id,{id:Y.id,routes:[{level:Y.level,pattern:Y.pattern}],entity:Y.entity,resolve:Y.resolve});}u(e,k+1,W,X);});if(jQuery.sap.log.Level.DEBUG===jQuery.sap.log.getLevel()){jQuery.sap.measure.end("fi-fio-tv-component-creation");jQuery.sap.measure.setActive(false);}return l;}function w(){var s=_.getId()+"---mainView";var e={};e.targets={list:{rootView:s,viewName:"Begin",viewId:"BeginViewId",controlId:"fcl",controlAggregation:"beginColumnPages"},detail:{rootView:s,viewName:"Middle",viewId:"MiddleViewId",controlId:"fcl",controlAggregation:"midColumnPages"},detaildetail:{rootView:s,viewName:"DetailDetail",viewId:"EndViewId",controlId:"fcl",controlAggregation:"endColumnPages"},notFound:{rootView:s,viewName:"NotFound",controlId:"fcl",controlAggregation:"midColumnPages"}};r=new R([],{async:true,controlId:"fcl",clearTarget:false,viewPath:"sap.fin.travel.lib.reuse.view",viewType:"XML",homeRoute:c.homeRoute},_,[]);r.initialize();r.getTargets().addTarget("list",e.targets.list);r.getTargets().addTarget("detail",e.targets.detail);r.getTargets().addTarget("detaildetail",e.targets.detaildetail);r.getTargets().addTarget("notFound",e.targets.notFound);}function x(i){var e=_.getId();switch(i){case F.layout.beginColumn.level:return{target:["list"],viewId:"BeginViewId",container:e+"---BeginViewId--beginPageComponent"};case F.layout.midColumn.level:return{target:["list","detail"],viewId:"MiddleViewId",container:e+"---MiddleViewId--middlePageComponent"};case F.layout.endColumn.level:default:return{target:["list","detail","detaildetail"],viewId:"EndViewId",container:e+"---EndViewId--detaildetailPageComponent"};}}function y(e,s){var i,k,j;if(s){i=s;}if(!i){return"";}if(i.indexOf("/")!==0){i="/"+i;}k=e.getParameter("arguments");if(k){for(j in k){if(j!=="?query"){i=i.replace("{"+j+"}",k[j]);}}return i;}}function z(e,i,j){var k=sap.ui.getCore().byId(e.container);k.setPropagateModel(true);jQuery.sap.log.info("Component loaded: bindingPath="+j+", current component="+k.getComponent()+", destination compomnent="+i.getId()+", container id="+e.container);if(k&&k.getComponent()!==i.getId()){k.unbindElement();}b.resetState(b.SUBMIT_ON_SIDEFFECT);k.setComponent(i);k.setVisible(true);k.bindElement({path:j,events:{change:function(s){B.hide();b.resetState(b.SUBMIT_ON_SIDEFFECT);if(!k.getBindingContext()){k.setVisible(false);var v=function(W){k.getModel("lastMessage").setProperty("/text",W.message);k.getModel("lastMessage").setProperty("/title",I.get().getText("ST_ERROR"));F.get().setNavigationBackLayout(F.layout.endColumn.level);r.getTargets().display("notFound");};M.get().preventNextShowMessage(v);}},dataRequested:function(s){if(b.hasState(b.SUBMIT_ON_SIDEFFECT)&&true===b.getState(b.SUBMIT_ON_SIDEFFECT)){B.hide();b.resetState(b.SUBMIT_ON_SIDEFFECT);}else{B.show();}},dataReceived:function(s){B.hide();}}});S.get().setHierarchy(i);S.get().setTitle(i,F.get().isFullScreen());}function G(s){if(D===true){throw new Error("Application is destroyed. Components could no longer be loaded!");}if(!l.has(s)){throw new Error("Component is not prepared for loading!");}var e=l.get(s);var i=new Promise(function(j){var k=function(W){if(!f.has(s)){f.set(s,W);}j(W);};if(f.has(s)){j(f.get(s));}else if(g.has(s)){g.get(s).then(k);}else{var v=Promise.resolve().then(e.resolve);g.set(s,v);v.then(k);}});return i;}function E(s){var e=undefined;l.forEach(function(v,k){if(k.endsWith("DetailPage."+s)){e=G(v.id);}});if(undefined===e){throw new Error("Could not retrieve component from its name '"+s+"'. Could not complete");}return e;}function J(e){var j=x(e);jQuery.sap.log.info("Unbind container: deepestLevel="+h+", iLevel="+e);for(var i=e+1;i<=h;++i){var k=x(i);var s=k&&sap.ui.getCore().byId(k.container);if(j.container===k.container){jQuery.sap.log.info("Unbind container is skipped at level="+i+" for container="+k.container);break;}if(s){jQuery.sap.log.info("Unbind container for level="+i+" for container="+k.container);s.unbindElement();}}}function K(){var s=this;if(H.getInstance().getHash()===""){H.getInstance().replaceHash("/");}else if(H.getInstance().getHash().startsWith("/")){H.getInstance().replaceHash("/"+H.getInstance().getHash());}l.forEach(function(W,X){W.routes.forEach(function(v,k){var Y=x(v.level);var Z=v.pattern||W.id;r.addRoute({name:Z,pattern:v.pattern,target:Y.target,layout:Y.layout});r.getRoute(Z).attachPatternMatched(function(a1){var b1=sap.ui.core.routing.HashChanger.getInstance().getHash();var c1=O.get().getCurrentTripContext();var d1=b1.match(/Tripno='(\d+)'/)&&b1.match(/Tripno='(\d+)'/)[1];var e1=b1.match(/Pernr='(\d+)'/)&&b1.match(/Pernr='(\d+)'/)[1];if(!U.isEmptyObjectOrString(c1.BindingPath)&&!U.isEmptyObjectOrString(d1)){var f1=c1&&c1.Tripno;switch(sap.ui.core.routing.History.getInstance().getDirection()){case sap.ui.core.routing.HistoryDirection.Backwards:if(!U.isEmptyObjectOrString(d1)&&!U.isEmptyObjectOrString(f1)&&T.TripNumber.Initial!==f1&&T.TripNumber.Initial===d1){window.history.back();return;}break;case sap.ui.core.routing.HistoryDirection.Forwards:if(!U.isEmptyObjectOrString(d1)&&!U.isEmptyObjectOrString(f1)&&T.TripNumber.Initial!==f1&&T.TripNumber.Initial===d1){window.history.forward();return;}break;}var g1=c1.BindingPath.match(/Tripno='(\d+)'/)&&c1.BindingPath.match(/Tripno='(\d+)'/)[1];var h1=[];if(d1!==g1){var i1=c1.BindingPath.replace(/Tripno='\d+'/,"Tripno='"+d1+"'");if(d1!==T.TripNumber.Initial){d.invalidateEntry(i1);Object.getOwnPropertyNames(d.getObject("/")).filter(function(e){if(e.indexOf("Tripno='"+d1+"'")>-1){d.invalidateEntry("/"+e);}});}if(g1===T.TripNumber.Initial){Object.getOwnPropertyNames(d.getObject("/")).filter(function(e){if(e.indexOf("Tripno='"+T.TripNumber.Initial+"'")>-1){d.invalidateEntry("/"+e);}});}}}var j1=y(a1,v.pattern);if(U.isEmptyObjectOrString(j1)){if(!U.isEmptyObjectOrString(c1.Pernr)&&!U.isEmptyObjectOrString(c1.Tripno)){var k1=G(c.rootComponent);k1.then(function(e){e.exitApplication();});}N.navigateToRoot();S.get().clearShell();J(0);return;}var l1=N.bindingPaths(j1).paths;var m1=v.level===F.layout.beginColumn.level?j1:l1[0];O.get().saveCurrentTripContext({BindingPath:m1});N.adjustLayout();var n1=[];var o1=[];$.each(l1,function(j,e){var i=j+1;var Y=x(i);var p1;if(i!==v.level){var q1=/\/(\w+)\(/.exec(e);q1=q1&&q1[1];if(U.isEmptyObjectOrString(q1)){throw new Error("Could not determine component name. Could not complete");}p1=E(q1);}else{p1=G(W.id);}n1.push({conf:Y,level:i,bindingPath:e});o1.push(p1);});Promise.all(o1).then(function(e){var j;var p1=e.map(function(i){return i.sEntitySet;});e.forEach(function(r1,i){var s1=n1[i];j=j&&j>s1.level?j:s1.level;r1.promiseComponentCreated.then(function(t1){var u1=t1.getModel("view");u1.setProperty("/level",s1.level);r1.promiseViewProcessed.then(function(v1){if(v1&&v1.adjustDynamicValues&&typeof v1.adjustDynamicValues==="function"){v1.adjustDynamicValues(p1);}});z(s1.conf,t1,s1.bindingPath);});});var q1=j;J(q1);});},s);if(W.id.indexOf("ListPage")!=-1){G(W.id).then(function(e){var i=H.getInstance().getHash();if(i==="/"){F.get().setNavigationLayout("",0,true);H.getInstance().replaceHash("");}else if(i.indexOf("/")===0){H.getInstance().replaceHash(i.substring(1));}else{H.getInstance().replaceHash("/"+i);}});}});});}function L(i,j,W){D=false;_=i;d=j;W.appDescriptor={"sap.ui.generic.app":W.appDescriptor};c=W;i.setModel(sap.ui.getCore().getMessageManager().getMessageModel(),"message");i.setModel(m.createDeviceModel(),"device");i.setModel(m.createGlobalModel(i),"_global");w();u();K();i.oShellServicePromise=i.getService("ShellUIService").catch(function(){jQuery.sap.log.warning("No ShellService available");});I.init(i);d.attachRequestFailed(function(k){var s=true;M.get().showMessage(k,s);});i.setModel(new sap.ui.model.json.JSONModel({}),"lastMessage");function X(){return r;}function Y(){return i.oShellServicePromise;}function Z(s,v){var k=i.getModel("_global");var g1=new C(k,"/");k.setProperty(s,v,g1);}function a1(){return i.getModel("_global");}function b1(g1){var h1=g1;var i1=g1>2000?g1-1000:1000;l.forEach(function(v,k){var s=new Date().getSeconds();setTimeout(function(){try{G(v.id);}catch(e){$.sap.log.error("Component could not be loaded:"+e);}},h1);h1=h1+i1;});}function c1(){return d;}function d1(s){return new Promise(function(g1){var h1=function(){_=null;c=null;d=null;f.forEach(function(v,k){v.destroy();});f=new Map();g=new Map();l=new Map();n=null;r.destroy();r=null;I.destroy();if(s&&"function"===typeof s){s(arguments);}g1();};var i1=G(c.rootComponent);D=true;i1.then(function(k){k.exitApplication({fnSuccess:h1,fnError:h1,bDestroy:true});});});}try{sap.ui.require(["sap/ui/core/CustomizingConfiguration"]);var e1=sap.ui.require("sap/ui/core/CustomizingConfiguration");if(undefined!==e1){var f1=e1.getControllerExtension;e1.getControllerExtension=function(s,v){var k=f1.call(e1,s,v);return k;};}}catch(e){jQuery.sap.log.warning("Customizing Configuration no longer available above ui5 1.97");}return{getConfig:o,getRouter:X,getGlobalModel:a1,updateGlobalModel:Z,getAppModel:c1,getComponent:G,getRootComponent:function(){return G(c.rootComponent);},getShellService:Y,destroy:d1,eagerLoad:b1,isDestroyed:function(){return D;}};}var Q;var V;return{get:function(){if(!Q){throw new Error("AppComponent has not been initialized yet.");}return Q;},init:function(e,i,j,s){var k=function(){Q=L(e,j,s);F.init(i,Q,o());P.init(Q);O.init(Q);S.init(Q);};if(V){V.then(k);}else{k();}},destroy:function(e){if(!Q){throw new Error("AppComponent has not been initialized yet.");}V=Q.destroy(e);V.then(function(){Q=null;F.destroy();P.destroy();O.destroy();S.destroy();a.destroy();V=null;});}};},true);
