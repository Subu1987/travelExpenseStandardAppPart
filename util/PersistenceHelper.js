/*
 * Copyright (C) 2009-2022 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/fin/travel/lib/reuse/util/BusyHelper","sap/fin/travel/lib/reuse/util/MessageUtil","sap/fin/travel/lib/reuse/util/AppComponent","sap/m/DraftIndicatorState","sap/fin/travel/lib/reuse/util/ODataModelUtil","sap/fin/travel/lib/reuse/util/Utils","sap/fin/travel/lib/reuse/util/ControlUtil","sap/fin/travel/lib/reuse/util/StateUtil"],function(B,M,A,D,O,U,C,S){"use strict";function g(){var a={"UNKNOWN":0,"SIDEEFFECT_ANNOTATION":1,"SIDEEFFECT_MANDATORY":2,"ACTION":3,"ITEM_PRESS":4,};Object.freeze(a);function s(e,i){if(e&&e.success&&typeof e.success==="function"){e.success.apply(null,i);}}function f(e,i){if(e&&e.submitChangeOrigin&&(e.submitChangeOrigin===a.SIDEEFFECT_MANDATORY||e.submitChangeOrigin===a.SIDEEFFECT_ANNOTATION)){$.sap.log.debug("We do not open the message popover automatically in case of single field modification");}else if(e==undefined||!C.getDialogPopup(e.source)){M.get().openMessagesPopover();}if(e&&e.functionalError&&typeof e.functionalError==="function"){e.functionalError.apply(null,i);}}function c(o,e){if(e&&undefined===e.functionalError){e.functionalError=e.error;}S.resetState(S.SUBMIT_ON_SIDEFFECT);var i=function(u,v){B.hide(e.control);A.get().updateGlobalModel("/draft",D.Clear);if(!M.get().handleMessageResponse(v)){s(e,arguments);}else{f(e,arguments);}if(e&&e.resolve&&typeof e.resolve==="function"){e.resolve.apply(null);}};var E=function(u){B.hide(e.control);if(e&&e.error&&typeof e.error==="function"){e.error.apply(null,arguments);}else{M.get().showMessage(u);}if(e&&e.reject&&typeof e.reject==="function"){e.reject.apply(null);}};var p=o.getMetaModel();var F=p.getODataFunctionImport(e.name.split("/")[1]);var q={method:F.httpMethod,success:i,error:E};if(e.urlParameters){q.urlParameters=e.urlParameters;}for(var t in e.settings){if(e.settings.hasOwnProperty(t)){q[t]=e.settings[t];}}B.show(e.control);o.callFunction(e.name,q);}function b(o,e){if(e&&undefined===e.functionalError){e.functionalError=e.error;}var i=e&&e.submitChangeOrigin||a.UNKNOWN;var p=i===a.SIDEEFFECT_ANNOTATION||i===a.SIDEEFFECT_MANDATORY;if(p){S.setState(S.SUBMIT_ON_SIDEFFECT,true);}else{S.resetState(S.SUBMIT_ON_SIDEFFECT);}var q=(i!==a.SIDEEFFECT_MANDATORY)&&(i!==a.SIDEEFFECT_ANNOTATION);if(o.hasPendingChanges()){var E=function(w){B.hide();A.get().updateGlobalModel("/draft",D.Clear);O.get().handleBackRefreshAfterChange(o);if(e&&e.error&&typeof e.error==="function"){e.error.apply(null,arguments);}else{M.get().showMessage(w);}};var t=function(w,x){B.hide();if(e&&e.draftIndicator){A.get().updateGlobalModel("/draft",D.Saved);}O.get().handleBackRefreshAfterChange(o);if(!M.get().handleMessageResponse(x)){s(e,arguments);}else{f(e,arguments);}M.get().cleanValidationMessages();};if(q){B.show();}var u={success:t,error:E};if(!U.isEmptyObjectOrString(e)){for(var v in e.settings){u[v]=e.settings[v];}}O.get().handleRefreshAfterChange(o);if(u.hasOwnProperty("refreshAfterChange")){o.setRefreshAfterChange(u.refreshAfterChange);}if(e&&e.draftIndicator){A.get().updateGlobalModel("/draft",D.Saving);}o.submitChanges(u);}else{if(!M.get().hasInternalError()){s(e,arguments[0]);}else{f(e,arguments[0]);}}}function d(o,e){var i=function(p,q){B.hide(e.control);if(!M.get().handleMessageResponse(q)){A.get().updateGlobalModel("/draft",D.Saved);if(e&&e.success&&typeof e.success==="function"){e.success.apply(null,arguments);}}};var F=function(p,q){A.get().updateGlobalModel("/draft",D.Clear);if(e&&e.functionalError&&typeof e.functionalError==="function"){e.functionalError.apply(null,arguments);}};var E=function(p){A.get().updateGlobalModel("/draft",D.Clear);if(e&&e.error&&typeof e.error==="function"){e.error.apply(null,arguments);}else{M.get().showMessage(p);}};A.get().updateGlobalModel("/draft",D.Saving);b(o,{success:i,error:E,functionalError:F});}function h(o,e,i){var p;var q=function(t,u){if(typeof i.success==="function"){i.success(t,u);}};var E=function(t){o.deleteCreatedEntry(p);if(typeof i.error==="function"){i.error(t);}};p=o.createEntry(e,{properties:i.properties,success:q,error:E,refreshAfterChange:true});if(i.submit===true||i.submit===undefined){b(o);}return p;}function j(o,e,E,i){S.resetState(S.SUBMIT_ON_SIDEFFECT);var p;var q=function(u,v){B.hide();if(!M.get().handleMessageResponse(v)){s(i,arguments);}else{f(i,arguments);}M.get().cleanValidationMessages();};var t=function(u){B.hide();if(typeof i.error==="function"){i.error(u);}};B.show();o.create(e,E,{success:q,error:t});}function m(o,p){return Object.getOwnPropertyNames(o.getObject("/")).filter(function(e){return e.startsWith(p.EntityType+"(");}).some(function(e){return-1!==e.indexOf("Tripno='"+p.Tripno+"'")&&-1!==e.indexOf("Pernr='"+p.Pernr+"'");});}function I(o,p){O.get().invalidateEntries(o,p);}function k(o,p){O.get().invalidatEentry(o,p);}function r(o,p,t){var P=o.getPendingChanges();if(!U.isEmptyObjectOrString(P)){Object.getOwnPropertyNames(P).filter(function(e){return-1!==e.indexOf("Pernr='"+p+"'");}).filter(function(e){return-1!==e.indexOf("Tripno='"+t+"'");}).forEach(function(e,i){if(0!==e.indexOf("/")){e="/"+e;}if(o.getProperty(e)){o.resetChanges([e]);}});}}function l(o,e){var i=true;if(e&&undefined!==e.invalidate){i=e.invalidate;}var p=function(){if(e&&e.success&&typeof e.success==="function"){e.success.apply(null,arguments);}if(i){I(o,{Pernr:e.urlParameters.Pernr,Tripno:e.urlParameters.Tripno,refreshAfterChange:e.settings.refreshAfterChange});}};c(o,{name:"/CancelTrip",success:p,error:e&&e.error,urlParameters:e&&e.urlParameters});}function R(o,p,P){o.read(p,P);}function n(o,p,e){S.resetState(S.SUBMIT_ON_SIDEFFECT);var i=function(q,t){B.hide();if(!M.get().handleMessageResponse(t)){s(e,arguments);}else{f(e,arguments);}M.get().refreshValidationMessages(p);};var E=function(q){B.hide();if(e&&e.error&&typeof e.error==="function"){e.error(q);}};if(o.getProperty(p)){o.resetChanges([p]);}B.show();o.remove(p,{success:i,error:E,refreshAfterChange:e&&e.refreshAfterChange});}return{submitChanges:b,apply:d,callFunction:c,createEntry:h,createDeepEntry:j,invalidateEntries:I,invalidateEntry:k,cancelTrip:l,read:R,remove:n,containsEntity:m,resetSubEntityChanges:r,SUBMIT_CHANGE_ORIGIN:a};}return g();},true);
