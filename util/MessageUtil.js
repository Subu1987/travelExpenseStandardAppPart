/*
 * Copyright (C) 2009-2022 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/MessageType","sap/ui/model/json/JSONModel","sap/fin/travel/lib/reuse/util/MessageParser","sap/m/MessageBox","sap/fin/travel/lib/reuse/util/i18n","sap/ui/core/ValueState","sap/ui/core/message/Message","sap/fin/travel/lib/reuse/util/Utils","sap/fin/travel/lib/reuse/util/FragmentHelper","sap/fin/travel/lib/reuse/util/AppContextHandler"],function(M,J,a,b,I,V,c,U,F,A){"use strict";var _;function d(){var e;var f=false;var T="TRV_MSG_ID";function g(E){var i={icon:b.Icon.ERROR,title:I.get().getText("ST_ERROR"),state:V.Error,detail:E.hasOwnProperty("detail")?E.detail:""};if(E.hasOwnProperty("type")){switch(E.type){case a.ErrorType.Warning:i.icon=b.Icon.WARNING;i.title=I.get().getText("ST_WARNING");i.state=V.Warning;case a.ErrorType.Info:i.icon=b.Icon.INFORMATION;i.title=I.get().getText("ST_INFO");i.state=V.Information;case a.ErrorType.Success:i.icon=b.Icon.SUCCESS;i.title=I.get().getText("ST_SUCCESS");i.state=V.Success;default:i.icon=b.Icon.ERROR;i.title=I.get().getText("ST_ERROR");i.state=V.Error;}}return i;}function h(){var i=sap.ui.getCore().getMessageManager().getMessageModel();return i&&i.getData()&&i.getData().length>0;}function H(){var x=false;if(h()){var y=sap.ui.getCore().getMessageManager().getMessageModel().getData();for(var i=0;i<y.length;i++){if(y[i].code===T){x|=y[i]&&(y[i].type===M.Error||y[i].type===M.Warning);}}}return x;}function j(i,x){var y=(i&&i.length>0)?i:sap.ui.getCore().getMessageManager().getMessageModel().getData();return k(y,x);}function k(x,y){var z=false;if(h()||x){var B=x;for(var i=0;i<B.length;i++){if(y&&y.length>0){z|=B[i]&&U.includes(y,[B[i].type]);}else{z|=B[i]&&(B[i].type===M.Error||B[i].type===M.Warning);}}}return z;}function l(i){var x=[];a.parseMessageResponseHeader(i,x);a.parseMessageResponseBatch(i,x);return k(x);}function m(i){var x=[];a.parseMessageResponseHeader(i,x);return k(x);}function n(i){var x=[];a.parseMessageResponseBatch(i,x);return k(x);}function G(E,W){var i=E;if(E){if(E.hasOwnProperty("responseText")){i=a.parseErrorMessage(E.responseText,W);}else if(E.hasOwnProperty("message")){i=E.message;}else if(E.hasOwnProperty("mParameters")&&E.mParameters.hasOwnProperty("response")){i=G(E.mParameters.response,W);}if(U.isEmptyObjectOrString(i)){i={type:"error",error:I.get().getText("UNKNOWN_ERROR").concat(": ",E.statusCode," ",E.statusText||E.message)};}}return i;}function o(i){var x=[];a.parseMessageResponseHeader(i,x);return x[0]||G(i);}function p(i){var x=[];a.parseMessageResponseBatch(i,x);return x[0]?x[0].message:G(i);}function q(i){var x=[];a.parseMessageResponseHeader(i,x);return x[0]||p(i);}function r(i){var x=[];a.parseMessageResponseBatch(i,x);a.parseMessageResponseHeader(i,x);return x;}function s(i,x){var E=i?(typeof i==="string"?i:G(i,true)):I.get().getText("UNKNOWN_ERROR");var y=g(E);var z=E.error?E.error:E;if(e==undefined||e.isOpen()!==true){F.get().loadFragment({id:"ErrorMessageDialogFragmentID",name:"sap.fin.travel.lib.reuse.view.fragments.ErrorMessage",controller:{close:function(){e.close();e=undefined;F.get().destroy("ErrorMessageDialogFragmentID");}},models:{message:new J({message:z,title:y.title,state:y.state,detail:y.detail,close:I.get().getText("CLOSE")})}}).then(function(B){if(B){e=B;if(f&&"function"===typeof f){if(x){f({message:z,title:y.title});}f=false;}else{e.open();}}});}else{}}function P(i){f=i;}function C(E){var x=false;var y=sap.ui.getCore().getMessageManager().getMessageModel();if(y&&y.getData()&&y.getData().length>0){for(var i=0;i<y.getData().length;i++){var z=y.getData()[i];if(z.target===E.target){return true;}}}return x;}function t(E){if(!C(E)){sap.ui.getCore().getMessageManager().addMessages([E]);}}function u(E){if(E){E.forEach(function(i){t(new c({code:T,message:i.message,type:V.Error,target:i.target}));});}O();}function v(){var x=[];var y=sap.ui.getCore().getMessageManager().getMessageModel();if(y&&y.getData()&&y.getData().length>0){for(var i=0;i<y.getData().length;i++){var z=y.getData()[i];if(z.code===T){x.push(z);}}}sap.ui.getCore().getMessageManager().removeMessages(x);}function R(B){var x=[];var y=sap.ui.getCore().getMessageManager().getMessageModel();if(B&&y&&y.getData()&&y.getData().length>0){for(var i=0;i<y.getData().length;i++){var z=y.getData()[i];if(z.code===T&&U.includes(z.target,B)){x.push(z);}}}sap.ui.getCore().getMessageManager().removeMessages(x);}function w(){var i=F.get().getFragment("TravelMessagePopoverFragmentID");if(i==undefined){jQuery.sap.log.error("Message Popover Fragment is not initialized !");return;}var x=A.getTargetMessageButton();if(x!=undefined&&x.isActive()){i.toggle(x);}}function O(){if(j()){var i=F.get().getFragment("TravelMessagePopoverFragmentID");if(i==undefined){jQuery.sap.log.error("Message Popover Fragment is not initialized !");return;}var x=A.getTargetMessageButton();if(x!=undefined&&!i.isOpen()){if(x.isActive()){i.toggle(x);if(!x.checkFieldGroupIds("MessagePopoverRedering")){var y=x.getFieldGroupIds();y.push("MessagePopoverRedering");x.setFieldGroupIds(y);}}else if(x.checkFieldGroupIds("MessagePopoverRedering")){var y=x.getFieldGroupIds();y.splice(y.indexOf("MessagePopoverRedering"),1);x.setFieldGroupIds(y);}}}}return{hasMessage:h,hasError:k,hasMessageManagerError:j,hasInternalError:H,handleMessageResponse:l,handleMessageHeader:m,handleMessageBatch:n,getErrorMessageResponse:q,getErrorMessageHeader:o,getErrorMessageBatch:p,getErrorMessage:G,getErrorMessagesResponse:r,showMessage:s,updateMessageManager:u,cleanValidationMessages:v,refreshValidationMessages:R,toggleMessagesPopover:w,openMessagesPopover:O,preventNextShowMessage:P};}return{get:function(){if(!_){_=d();}return _;}};},true);
