/*
 * Copyright (C) 2009-2022 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["jquery.sap.global","jquery.sap.resources","./../library","sap/m/UploadCollection","sap/fin/travel/lib/reuse/util/formatters","sap/fin/travel/lib/reuse/util/FileUploadHelper","sap/m/library","sap/fin/travel/lib/reuse/util/TravelUtil","sap/ui/model/json/JSONModel","sap/fin/travel/lib/reuse/util/MessageParser","sap/fin/travel/lib/reuse/util/Utils"],function(q,r,l,U,f,F,M,T,J,a,b){"use strict";var c=U.extend("sap.fin.travel.lib.reuse.controls.UploadCollectionExtension",{renderer:"sap.m.UploadCollectionRenderer"});c.prototype.init=function(){var t=this;this.bindProperty("uploadEnabled",{path:"Tripno",formatter:function(v){return 0!==parseInt(v);}});this.bFirstRender=true;this.sContextPath="/";this.oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.fin.travel.lib.reuse");this.oFileUploader=new sap.ui.unified.FileUploader(this.getId()+"-bus_doc_file_uploader",{sendXHR:true,useMultipart:false,enabled:{parts:[{path:"Tripno"},{path:"Receiptno"}],formatter:function(s,R){return 0!==parseInt(s)||R!=undefined;}},placeholder:"test1",sameFilenameAllowed:true,change:function(e){F.beforeUploadFile(e);},typeMissmatch:function(e){F.fileTypeMissmatchHandler(e,t.oFileUploader.getMimeType());},fileSizeExceed:function(e){F.fileSizeExceedHandler(e,t.oFileUploader.getMaximumFileSize());},uploadComplete:function(e){F.onBusDocUploadComplete(e,t);}});sap.m.UploadCollection.prototype.init.apply(this,arguments);this.bindProperty("noDataText",{parts:[{path:"Tripno"},{path:"Receiptno"}],formatter:function(s,R){return(0===parseInt(s)&&R==undefined)?this.oResourceBundle.getText("ATTACHMENT_NO_DATA_UNSAVED_TRIP"):"";}});this.bindProperty("noDataDescription",{parts:[{path:"Tripno"},{path:"Receiptno"}],formatter:function(s,R){return(0===parseInt(s)&&R==undefined)?"":this._isDragAndDropAllowed()?this.oResourceBundle.getText("ATTACHMENT_NO_DATA_DRAG_DROP"):this.oResourceBundle.getText("ATTACHMENT_NO_DATA");}});this.attachChange(F.beforeUploadFile);this.attachUploadComplete(F.onGOSUploadComplete);this.attachFileDeleted(F.deleteUploadedFile);};c.prototype.onBeforeRendering=function(){sap.m.UploadCollection.prototype.onBeforeRendering.apply(this,arguments);var t=this;this.getToolbar().getAggregation("content")[0].setVisible(false);this.getToolbar().getAggregation("content")[2].addStyleClass("sapUiHiddenPlaceholder");this._buildControl();this.attachModelContextChange(function(){t._buildControl();});};c.prototype._createIcon=function(i){var I=sap.m.UploadCollection.prototype._createIcon.apply(this,arguments);if(!i.getProperty("mimeType")){I.setSrc("sap-icon://chain-link");}else if(i.getProperty("mimeType")==="text/plain"&&!i.getProperty("fileName").toLowerCase().endsWith(".txt")){I.setSrc("sap-icon://notes");}return I;};c.prototype._onItemPressed=function(e,i){if(i.hasListeners("press")){i.firePress();}else if(this.sErrorState!=="Error"&&q.trim(i.getProperty("url"))){this._triggerLink(e,i);}};c.prototype._triggerLink=function(e,i){if(this.editModeItem){this._handleOk(e,this.editModeItem,true);if(this.sErrorState==="Error"){return;}this.sFocusId=e.getParameter("id");}M.URLHelper.redirect(i.getProperty("url"),true);};c.prototype.setUploadEnabled=function(u){var o=sap.m.UploadCollection.prototype.setUploadEnabled.apply(this,arguments);var A=sap.ui.getCore().byId(this.getId()+"-addAttachmentButton");if(A){A.setEnabled(u);}var d=sap.ui.getCore().byId(this.getId()+"-addNoteButton");if(d){d.setEnabled(u);}var e=sap.ui.getCore().byId(this.getId()+"-addLinkButton");if(e){e.setEnabled(u);}var g=sap.ui.getCore().byId(this.getId()+"-addBusDocButton");if(g){g.setEnabled(u);}return o;};c.prototype._isDragAndDropAllowed=function(){var i=sap.m.UploadCollection.prototype._isDragAndDropAllowed.apply(this,arguments);var B=this.getBindingContext();var A,d;if(B){var C=B.getProperty("/UserProfiles('"+B.getProperty("Pernr")+"')");A=C&&C.Attaenabled;d=C&&C.Arlenabled;}return i&&A&&!d;};c.prototype.exit=function(){this.oFileUploader.destroy();var t=this.getToolbar()&&this.getToolbar().getAggregation("content");for(var i in t){t[i].destroy();}if(this.oAddBusDocDialog){this.oAddBusDocDialog.destroy();}if(this.oAddNoteDialog){this.oAddNoteDialog.destroy();}if(this.oAddLinkDialog){this.oAddLinkDialog.destroy();}sap.m.UploadCollection.prototype.exit.apply(this,arguments);};c.prototype._buildControl=function(){var t=this,i,d="HRITRV_UPL";i=false;if(t.getBindingContext()&&t.getBindingContext().getPath()!==t.sContextPath){t.oFileUploader.setBindingContext(t.getBindingContext());t.sContextPath=t.getBindingContext().getPath();if(t.bFirstRender){var B=t.getBindingContext();var C=B.getProperty("/UserProfiles('"+B.getProperty("Pernr")+"')");var u="${true}";var A="{Attachmenteditable}";if(B.getProperty("Receiptno")){i=true;C.Attaenabled=false;C.Noteenabled=false;C.Urlenabled=false;u="!${DisplayMode}";}if(C&&C.Attaenabled){t.getToolbar().addContent(new sap.m.Button({id:t.getId()+"-addAttachmentButton",icon:"sap-icon://customIcons/custom-add-attachment",enabled:"{= parseInt(${Tripno}) !== 0}",visible:A,type:sap.m.ButtonType.Transparent,tooltip:t.oResourceBundle.getText("ADD_ATTACHMENT"),press:function(){var s='onclick'in window?'click':'touchstart';$(t._oFileUploader.oFileUpload).trigger(s);}}));}if(C&&C.Noteenabled){var e=function(){sap.ui.getCore().byId(t.getId()+"-note_name").setValue("");sap.ui.getCore().byId(t.getId()+"-note_descrip").setValue("");t.oAddNoteDialog.close();};t.getToolbar().addContent(new sap.m.Button({id:t.getId()+"-addNoteButton",icon:"sap-icon://customIcons/custom-add-note",enabled:"{= parseInt(${Tripno}) !== 0}",visible:A,type:sap.m.ButtonType.Transparent,tooltip:t.oResourceBundle.getText("ADD_NOTE"),press:function(E){var s=E.getSource();if(!t.oAddNoteDialog){t.oAddNoteDialog=new sap.m.Dialog({title:t.oResourceBundle.getText("ADD_NOTE"),content:[new sap.ui.layout.VerticalLayout({class:"sapUiContentPadding",visible:"{= ${uploadCollectionModel>/stripMessage}.length > 0}",width:"100%",content:new sap.m.MessageStrip({text:"{uploadCollectionModel>/stripMessage}",type:"{uploadCollectionModel>/stripType}",showIcon:true})}),new sap.ui.layout.form.Form({editable:true,layout:new sap.ui.layout.form.ResponsiveGridLayout(),formContainers:[new sap.ui.layout.form.FormContainer({formElements:[new sap.ui.layout.form.FormElement({label:new sap.m.Label({text:t.oResourceBundle.getText("NOTE_TITLE"),labelFor:t.getId()+"-note_name",required:true}),fields:new sap.m.Input(t.getId()+"-note_name",{maxLength:50})}),new sap.ui.layout.form.FormElement({label:new sap.m.Label({text:t.oResourceBundle.getText("NOTE_TEXT"),labelFor:t.getId()+"-note_descrip",required:true}),fields:new sap.m.TextArea(t.getId()+"-note_descrip",{})})]})]})],beginButton:new sap.m.Button({text:t.oResourceBundle.getText("ADD"),type:"Emphasized",press:function(){var n=sap.ui.getCore().byId(t.getId()+"-note_name").getValue();if(s.getBindingContext().getProperty("Tripno")===sap.fin.travel.lib.reuse.util.TravelUtil.TripNumber.Initial){sap.m.MessageBox.show(t.oResourceBundle.getText("NOTEUPLOAD_ERROR_NOTE_BEFORE_UPLOAD",n),{icon:sap.m.MessageBox.Icon.ERROR,title:t.oResourceBundle.getText("ERROR"),details:t.oResourceBundle.getText("FILEUPLOAD_ERROR_IN_CREATION_MODE_FILE_BEFORE_UPLOAD"),actions:[sap.m.MessageBox.Action.CLOSE]});return;}var j=sap.ui.getCore().byId(t.getId()+"-note_descrip").getValue();if(!n||!j||n.trim().length===0||j.trim().length===0){sap.m.MessageToast.show(t.oResourceBundle.getText("REQ_FIELD_ALERT"));return;}var k=function(m){var o=t.oAddNoteDialog.getModel("uploadCollectionModel");if(sap.fin.travel.lib.reuse.util.MessageUtil.get().handleMessageResponse(m)){var p=sap.fin.travel.lib.reuse.util.MessageUtil.get().getErrorMessageResponse(m);o.setProperty("/stripMessage",p.hasOwnProperty("message")?p.message:p);var v=p.hasOwnProperty("type")?a.ErrorType.toMessageType(p.type):sap.ui.core.MessageType.Error;o.setProperty("/stripType",v);}else{o.setProperty("/stripMessage",sap.fin.travel.lib.reuse.util.MessageUtil.get().getErrorMessage(m));o.setProperty("/stripType",sap.ui.core.MessageType.Error);}};var S=function(){var o=t.oAddNoteDialog.getModel("uploadCollectionModel");o.setProperty("/stripMessage","");o.setProperty("/stripType",sap.ui.core.MessageType.None);e();};sap.fin.travel.lib.reuse.util.FileUploadHelper.uploadText(n,j,true,t,S,k);}}),endButton:new sap.m.Button({text:t.oResourceBundle.getText("CANCEL"),press:e})});t.oAddNoteDialog.setModel(new sap.ui.model.json.JSONModel({stripMessage:"",stripType:sap.ui.core.MessageType.None}),"uploadCollectionModel");}var o=t.oAddNoteDialog.getModel("uploadCollectionModel");o.setProperty("/stripMessage","");o.setProperty("/stripType",sap.ui.core.MessageType.None);t.oAddNoteDialog.open();}}));}if(C&&C.Urlenabled){var g=function(){sap.ui.getCore().byId(t.getId()+"-link_name").setValue("");sap.ui.getCore().byId(t.getId()+"-link_descrip").setValue("");t.oAddLinkDialog.close();};t.getToolbar().addContent(new sap.m.Button({id:t.getId()+"-addLinkButton",icon:"sap-icon://customIcons/custom-add-link",enabled:"{= parseInt(${Tripno}) !== 0}",visible:A,type:sap.m.ButtonType.Transparent,tooltip:t.oResourceBundle.getText("ADD_LINK"),press:function(E){var s=E.getSource();if(!t.oAddLinkDialog){t.oAddLinkDialog=new sap.m.Dialog({title:t.oResourceBundle.getText("ADD_LINK"),content:[new sap.ui.layout.VerticalLayout({class:"sapUiContentPadding",visible:"{= ${uploadCollectionModel>/stripMessage}.length > 0}",width:"100%",content:new sap.m.MessageStrip({text:"{uploadCollectionModel>/stripMessage}",type:"{uploadCollectionModel>/stripType}",showIcon:true})}),new sap.ui.layout.form.Form({editable:true,layout:new sap.ui.layout.form.ResponsiveGridLayout(),formContainers:[new sap.ui.layout.form.FormContainer({formElements:[new sap.ui.layout.form.FormElement({label:new sap.m.Label({text:t.oResourceBundle.getText("LINK_TITLE"),labelFor:t.getId()+"-link_name",required:true}),fields:new sap.m.Input(t.getId()+"-link_name",{maxLength:50})}),new sap.ui.layout.form.FormElement({label:new sap.m.Label({text:t.oResourceBundle.getText("LINK_URL"),labelFor:t.getId()+"-link_descrip",required:true}),fields:new sap.m.Input(t.getId()+"-link_descrip",{type:sap.m.InputType.Url})})]})]})],beginButton:new sap.m.Button({text:t.oResourceBundle.getText("ADD"),type:"Emphasized",press:function(){var n=sap.ui.getCore().byId(t.getId()+"-link_name").getValue();if(s.getBindingContext().getProperty("Tripno")===sap.fin.travel.lib.reuse.util.TravelUtil.TripNumber.Initial){sap.m.MessageBox.show(t.oResourceBundle.getText("LINKUPLOAD_ERROR_LINK_BEFORE_UPLOAD",n),{icon:sap.m.MessageBox.Icon.ERROR,title:t.oResourceBundle.getText("ERROR"),details:t.oResourceBundle.getText("FILEUPLOAD_ERROR_IN_CREATION_MODE_FILE_BEFORE_UPLOAD"),actions:[sap.m.MessageBox.Action.CLOSE]});return;}var j=sap.ui.getCore().byId(t.getId()+"-link_descrip").getValue();if(!n||!j||n.trim().length===0||j.trim().length===0){sap.m.MessageToast.show(t.oResourceBundle.getText("REQ_FIELD_ALERT"));return;}var k=function(m){var o=t.oAddLinkDialog.getModel("uploadCollectionModel");if(sap.fin.travel.lib.reuse.util.MessageUtil.get().handleMessageResponse(m)){var p=sap.fin.travel.lib.reuse.util.MessageUtil.get().getErrorMessageResponse(m);o.setProperty("/stripMessage",p.hasOwnProperty("message")?p.message:p);var v=p.hasOwnProperty("type")?a.ErrorType.toMessageType(p.type):sap.ui.core.MessageType.Error;o.setProperty("/stripType",v);}else{o.setProperty("/stripMessage",sap.fin.travel.lib.reuse.util.MessageUtil.get().getErrorMessage(m));o.setProperty("/stripType",sap.ui.core.MessageType.Error);}};var S=function(){var o=t.oAddLinkDialog.getModel("uploadCollectionModel");o.setProperty("/stripMessage","");o.setProperty("/stripType",sap.ui.core.MessageType.None);g();};sap.fin.travel.lib.reuse.util.FileUploadHelper.uploadText(n,j,false,t,S,k);}}),endButton:new sap.m.Button({text:t.oResourceBundle.getText("CANCEL"),press:g})});t.oAddLinkDialog.setModel(new sap.ui.model.json.JSONModel({stripMessage:"",stripType:sap.ui.core.MessageType.None}),"uploadCollectionModel");}var o=t.oAddLinkDialog.getModel("uploadCollectionModel");o.setProperty("/stripMessage","");o.setProperty("/stripType",sap.ui.core.MessageType.None);t.oAddLinkDialog.open();}}));}if(C&&C.Arlenabled){var h=function(){sap.ui.getCore().byId(t.getId()+"-bus_doc_type_select").setSelectedItemId("");sap.ui.getCore().byId(t.getId()+"-bus_doc_descrip").setValue("");t.oFileUploader.clear();var p=t.oFileUploader.removeAllHeaderParameters();p.forEach(function(P){P.destroy();});t.oAddBusDocDialog.close();};var D;t.getToolbar().addContent(new sap.m.Button({id:t.getId()+"-addBusDocButton",icon:"sap-icon://add-document",enabled:{parts:[{path:"Tripno"},{path:"Receiptno"}],formatter:function(s,R){return 0!==parseInt(s)||R!=undefined;}},visible:i?"{= "+u+"}":A,type:sap.m.ButtonType.Transparent,tooltip:t.oResourceBundle.getText("ADD_BUS_DOC"),press:function(){D="";if(!t.oAddBusDocDialog){t.oAddBusDocDialog=new sap.m.Dialog({title:t.oResourceBundle.getText("ADD_BUS_DOC"),content:new sap.ui.layout.form.Form({editable:true,layout:new sap.ui.layout.form.ResponsiveGridLayout(),formContainers:[new sap.ui.layout.form.FormContainer({formElements:[new sap.ui.layout.form.FormElement({label:new sap.m.Label({text:t.oResourceBundle.getText("DOC_TYPE"),labelFor:t.getId()+"-bus_doc_type_select",required:true,visible:!i}),fields:new sap.m.Select(t.getId()+"-bus_doc_type_select",{change:function(E){var p=t.oFileUploader.removeHeaderParameter("Document-Type");if(p){p.destroy();}var o=E.getSource().getSelectedItem().getKey();t.oFileUploader.addHeaderParameter(new sap.ui.unified.FileUploaderParameter("Document-Type",{name:"Document-Type",value:i?d:o}));var j=t.getModel().getProperty("/DocumentTypes('"+o+"')");t.oFileUploader.setMimeType(j.AllowedMimetypes.split(";"));t.oFileUploader.setMaximumFileSize(parseFloat(j.MaxSize)/1024/1024);},visible:!i,forceSelection:i})}),new sap.ui.layout.form.FormElement({label:new sap.m.Label({text:t.oResourceBundle.getText("FILE_PATH"),labelFor:t.getId()+"-bus_doc_file_uploader",required:true}),fields:t.oFileUploader}),new sap.ui.layout.form.FormElement({label:new sap.m.Label({text:t.oResourceBundle.getText("DESCRIPTION"),labelFor:t.getId()+"-bus_doc_descrip"}),fields:new sap.m.Input(t.getId()+"-bus_doc_descrip",{liveChange:function(E){D=E.getSource().getValue();},maxLength:60})})]})]}),beginButton:new sap.m.Button({text:t.oResourceBundle.getText("UPLOAD"),type:"Emphasized",press:function(){if(!sap.ui.getCore().byId(t.getId()+"-bus_doc_type_select").getSelectedItemId()||!t.oFileUploader.getValue()){sap.m.MessageToast.show(t.oResourceBundle.getText("REQ_FIELD_ALERT"));return;}if(!b.isEmptyObjectOrString(D)){t.oFileUploader.addHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"Document-Description",value:encodeURI(D)}));}t.oFileUploader.upload();h();}}),endButton:new sap.m.Button({text:t.oResourceBundle.getText("CANCEL"),press:h})});var m=t.getModel();t.oAddBusDocDialog.setModel(m);t.oAddBusDocDialog.setBindingContext(t.getBindingContext());sap.ui.getCore().byId(t.getId()+"-bus_doc_type_select").bindItems("/DocumentTypes",new sap.ui.core.Item({key:"{DocType}",text:"{Descr}"}));}t.oAddBusDocDialog.open();}}));}}t.bFirstRender=false;}};return c;},true);
